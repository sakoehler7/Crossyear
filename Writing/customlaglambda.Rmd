---
title: "Custom Lag Lambda"
author: "Sarah Koehler"
date: "October 14, 2016"
output: pdf_document
---

```{r}
library(dplyr)
```


#Piecewise relative risks

Making some binary exposure values and a baseline:

```{r, message=F}
#Simulated binary exposure values from eesim
library(dlnm)
library(eesim)
set.seed(8)
```

Simulated binary exposure: 

```{r fig.align = "center", fig.width = 8, fig.height = 2.5}
expo <- sim_exposure(n = 1000, central = .01, amp = .01,
                     exposure_type = "binary")
calendar_plot(expo, type = "discrete", labels = c("Not exposed", "Exposed"))
```


Simulated outcome (no seasonal or longterm trends): 

```{r fig.align = "center", fig.width = 8, fig.height = 2.5}
base <- create_baseline(1000, 58, trend="no trend")
calendar_plot(base, type = "continuous")
```


We created a custom lambda function that allows you to simulate data under the condition that same-day exposure has a certain relative risk, but that there is also some (possibly different) delayed relative risk on days following the event. This package draws on functions in `dlnm` to simulate this data. The main inputs to this function are simulated exposure and baseline time series, as well as specifications of relative risk lagged following an exposure, and the output is a numeric vector with the expected number of outcomes (based on the baseline trends and exposure on that day and previous days) for each day over the time period. Here is the code:

```{r}
source("../R/dlnmfuncs.R")
stratalambda
```

Here is an example of using this function to create simulated outcome data under the scenario that same-day exposure to a binary event has a relative risk of 1.20, exposure on days 1 to 2 after the event has a relative risk of 1.05, and exposure on days 3 to 6 after the event has a relative risk of 1.01:

```{r fig.align = "center", fig.width = 8, fig.height = 2.5}
strat <- stratalambda(exposure = expo$x, baseline = base$baseline,
                      rrvalues = c(.2, .05, .01), lag = 6,
                      argvar = list(fun = "lin"),
                      arglag = list(fun="strata", breaks = c(0,1,3)))
calendar_plot(data_frame(expo$date, strat), type = "continuous")
```

This returns a vector of expected daily mortality on each day of the time series.  

You can use this custom function in `sim_outcome` to simulate a timeseries of daily outcomes (e.g., daily mortality count):

```{r}
out <- sim_outcome(exposure = expo, average_outcome = 58,
                   trend = "no trend", cust_lambda_func = stratalambda,
                   cust_lambda_args = list(exposure = expo$x,
                                           baseline = base,
                                           rrvalues = c(.7, .5, .3),
                                           lag=15,
                                           argvar = list(fun = "lin"),
                                           arglag = list(fun="strata",
                                                         breaks = c(0,4,9))))
plot(out$outcome)
which(expo$x==1)
```

```{r fig.align = "center", fig.width = 8, fig.height = 2.5}
calendar_plot(out %>% select(date, outcome), type = "continuous")
```


# Continuous relative risks

```{r, message = F}
#Custom function to create desired vector of rr:
smoothrr 

#Example:
set.seed(15)
testexpo <- sim_exposure(n=200, central = .01, amp = .01,
                         exposure_type = "binary")
testrr <- smoothrr(testexpo$x, lag = 20, scale = 6)
plot(testrr)
```

Here is a plot of what the relative risks look like over time.  They look linear here, but they're not actually linear because I'm using an exponential function, I'm pretty sure.

For this function to work, we need there to be no exposures in the first lag number of days, and we may need each exposure to be at least lag number of days apart.  

Now here's an example of using this function in eesim. The scale parameter adjusts what the initial relative risk is.  A scale of 6 will set the relative risk on day zero to be around 1.2.

```{r}
base <- create_baseline(200, 58, trend = "no trend")

#Lambda function:
smoothlambda 

smoothlambda(exposure=testexpo$x, baseline = base$baseline, lag = 20,
             scale = 2)

#Example in sim_outcome:
out <- sim_outcome(testexpo, average_outcome = 58,
                   trend = "no trend", cust_lambda_func = smoothlambda,
                   cust_lambda_args = list(testexpo$x,
                                           baseline = base$baseline,
                                           lag = 20, scale = 2))
plot(out$outcome)
which(testexpo$x==1)
```

This is an extreme case because the relative risk on day zero is around 1.65 (because the scale is set at 2).  I wanted to show the pattern though, which is evident in this plot.  
